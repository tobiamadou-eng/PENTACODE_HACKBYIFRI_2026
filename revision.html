<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>R√©vision - SMARTLEARN</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="dashboard-body">

    <div class="dashboard-container">
        <h1>R√©vision personnalis√©e</h1>

        <!-- Contenu dynamique inject√© ici -->
        <div id="revisionContent"></div>
    </div>

<script>

let revisionData = JSON.parse(localStorage.getItem("revisionData")) || {
    sessions: 1,
    duration: 20,
    wrongAnswers: []
};

let currentSession = 1;
let totalScore = 0;
let totalQuestions = 0;

function startRevision(){
    showExplanation();
}

function showExplanation(){

    const errors = revisionData.wrongAnswers || [];

    let explanationContent = "";

    if(errors.length > 0){
        explanationContent = errors.map(e =>
            `<p><strong>${e.question}</strong><br>${e.explanation}</p>`
        ).join("");
    } else {
        explanationContent = "<p>R√©vision g√©n√©rale de consolidation.</p>";
    }

    document.getElementById("revisionContent").innerHTML = `
        <div class="quiz-box">
            <h3>S√©ance ${currentSession} / ${revisionData.sessions}</h3>

            <h4>Points √† retravailler :</h4>
            ${explanationContent}

            <button class="btn-primary" onclick="startMiniQuiz()">
                V√©rifier ma compr√©hension
            </button>
        </div>
    `;
}

function startMiniQuiz(){

    const questions = revisionData.wrongAnswers || [];

    if(questions.length === 0){
        finishRevision();
        return;
    }

    let currentQ = 0;
    let sessionScore = 0;

    let remainingTime = revisionData.duration * 60;
    let timerInterval;

    function startTimer(){
        timerInterval = setInterval(() => {

            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;

            document.getElementById("timerDisplay").innerText =
                minutes.toString().padStart(2,'0') + ":" +
                seconds.toString().padStart(2,'0');

            if(remainingTime > 0){
                remainingTime--;
            } else {
                clearInterval(timerInterval);
                finishSession();
            }

        }, 1000);
    }

    function showQuestion(){

        const q = questions[currentQ];

        document.getElementById("revisionContent").innerHTML = `
            <div class="quiz-box">
                <h3>S√©ance ${currentSession} / ${revisionData.sessions}</h3>

                <div class="timer-display" id="timerDisplay">
                    ${revisionData.duration}:00
                </div>

                <h4>Question ${currentQ+1} / ${questions.length}</h4>
                <p>${q.question}</p>

                <textarea id="answerBox" placeholder="Votre r√©ponse..."></textarea>

                <button class="btn-primary" onclick="checkAnswer()">
                    Valider
                </button>

                <div id="feedbackArea"></div>
            </div>
        `;

        if(currentQ === 0){
            startTimer();
        }
    }

    window.checkAnswer = function(){

        const answer = document.getElementById("answerBox").value.trim();
        const q = questions[currentQ];

        if(answer === ""){
            alert("Veuillez √©crire une r√©ponse.");
            return;
        }

        const feedbackArea = document.getElementById("feedbackArea");

        // V√©rification simple : on compare avec explication
        if(answer.toLowerCase().includes(q.explanation.toLowerCase().substring(0,20))){
            sessionScore++;
            feedbackArea.innerHTML = `
                <div class="correction-block">
                    ‚úÖ Bonne r√©ponse ! Excellent travail.
                </div>
                <button class="btn-primary" onclick="nextQuestion()">
                    Question suivante
                </button>
            `;
        }
        else{
            feedbackArea.innerHTML = `
                <div class="error-block">
                    ‚ùå R√©ponse incorrecte.<br><br>
                    <strong>Correction :</strong><br>
                    ${q.explanation}
                </div>
                <button class="btn-primary" onclick="nextQuestion()">
                    Continuer
                </button>
            `;
        }

        totalQuestions++;
    }

    window.nextQuestion = function(){
        currentQ++;

        if(currentQ < questions.length){
            showQuestion();
        } else {
            clearInterval(timerInterval);
            finishSession();
        }
    }

    function finishSession(){

        const percentage = Math.round((sessionScore / questions.length) * 100);
        totalScore += sessionScore;

        document.getElementById("revisionContent").innerHTML = `
            <div class="quiz-box">
                <h3>Score de la s√©ance</h3>
                <div class="score-display">${percentage}%</div>

                <button class="btn-primary" onclick="nextSession()">
                    Continuer
                </button>
            </div>
        `;
    }

    showQuestion();
}


function nextSession(){

    if(currentSession < revisionData.sessions){
        currentSession++;
        showExplanation();
    } else {
        finishRevision();
    }
}

function finishRevision(){

    let finalPercentage = totalQuestions > 0
        ? Math.round((totalScore / totalQuestions) * 100)
        : 100;

    let nextPlan = "";
    let message = "";

    if(finalPercentage >= 75){

        message = `
            <div class="correction-block">
                üéâ F√©licitations !<br><br>
                Vous avez consolid√© vos connaissances avec succ√®s.<br>
                Aucune nouvelle s√©ance n'est n√©cessaire.
            </div>
        `;

    } else {

        // Planification intelligente
        let extraSessions;
        let newDuration;

        if(finalPercentage < 50){
            extraSessions = 2;
            newDuration = 30;
        } else {
            extraSessions = 1;
            newDuration = 20;
        }

        // Mise √† jour du planning
        localStorage.setItem("revisionData", JSON.stringify({
            sessions: extraSessions,
            duration: newDuration,
            wrongAnswers: revisionData.wrongAnswers
        }));

        nextPlan = `
            <div class="error-block">
                üìö Consolidation recommand√©e.<br><br>
                ${extraSessions} nouvelle(s) s√©ance(s) de ${newDuration} minutes planifi√©e(s).
            </div>

            <button class="btn-primary" onclick="startRevision()">
                Commencer la nouvelle s√©ance
            </button>
        `;
    }

    document.getElementById("revisionContent").innerHTML = `
        <div class="quiz-box">
            <h3>Score global final</h3>
            <div class="score-display">${finalPercentage}%</div>

            ${message}
            ${nextPlan}

            <br>
            <button class="btn-secondary" onclick="goBack()">
                Retour au dashboard
            </button>
        </div>
    `;
}

function goBack(){
    window.location.href = "dashboard.html";
}

startRevision();

</script>

</body>
</html>